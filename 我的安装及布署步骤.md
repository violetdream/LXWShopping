#  [运维及部署](http://120.79.28.199/index.html)

## 准备环境

* 一台2G单核服务器，1M宽带，装有CentOS7.6操作系统
* 对操作系统更新并安装依赖

``` shell
yum -y update
yum install -y conntrack ipvsadm ipset jq sysstat curl iptables libseccomp
#对系统相关参数设置
01 `关闭防火墙`
	systemctl stop firewalld && systemctl disable firewalld
02 `关闭selinux`
	setenforce 0
	sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
03 `关闭swap`
	swapoff -a
	sed -i '/swap/s/^\(.*\)$/#\1/g' /etc/fstab
04 `配置iptables的ACCEPT规则`
	iptables -F && iptables -X && iptables \
    -F -t nat && iptables -X -t nat && iptables -P FORWARD ACCEPT
05 `设置系统参数`
# ====================================================================================
cat <<EOF >  /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system
# ======================================================================================
```

### 安装openjdk或Oracle JDK

``` shell
yum list | grep openjdk
yum install java-11-openjdk.x86_64安装Git
`默认安装在目录/usr/lib/jvm/java-11-openjdk-11.0.5.10-0.el7_7.x86_64`
#下载并上传jdk-11.0.5_linux-x64_bin.tar.gz至目录/lxw/java/
cd /lxw/java
tar -zxvf jdk-11.0.5_linux-x64_bin.tar.gz
配置/etc/profile
export MAVEN_HOME=/lxw/maven/apache-maven-3.6.3
export JAVA_HOME=/lxw/java/jdk-11.0.5
export PATH=$JAVA_HOME/bin:$MAVEN_HOME/bin:$PATH

#建立软连接
ln -s /lxw/java/jdk-11.0.5/bin/java /usr/bin/java
```

### 安装Git

``` shell
yum list | grep git
yum install git
`默认安装在目录/usr/libexec/git-core`
#温馨提示：在Windows下设置下
git config --global core.autocrlf false
```

### 安装Maven

``` shell
cd /lxw/maven
wget http://mirror.bit.edu.cn/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz
tar -zxvf apache-maven-3.6.3-bin.tar.gz
mkdir repo
#配置环境变量,修改maven本地仓库存放路径及mirror境像地址
vi /lxw/maven/apache-maven-3.6.3/conf/settings.xml
通过修改profile文件:
vim /etc/profile
/export PATH //找到设置PATH的行，添加
export MAVEN_HOME=/lxw/maven/apache-maven-3.6.3
export PATH=$JAVA_HOME/bin:$MAVEN_HOME/bin:$PATH
生效方法：系统重启
有效期限：永久有效
用户局限：对所有用户
shutdown -r now 或  source /etc/profile 生效
mvn -v
Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)
Maven home: /lxw/maven/apache-maven-3.6.3
Java version: 11.0.5, vendor: Oracle Corporation, runtime: /usr/lib/jvm/java-11-openjdk-11.0.5.10-0.el7_7.x86_64
Default locale: en_US, platform encoding: UTF-8
OS name: "linux", version: "3.10.0-1062.9.1.el7.x86_64", arch: "amd64", family: "unix"

#使和软链接，把mvn命令建立到/usr/bin目录下
`Usage: ln [OPTION]... [-T] TARGET LINK_NAME   (1st form)\
  or:  ln [OPTION]... TARGET                  (2nd form)\
  or:  ln [OPTION]... TARGET... DIRECTORY     (3rd form)\
  or:  ln [OPTION]... -t DIRECTORY TARGET...  (4th form)\
In the 1st form, create a link to TARGET with the name LINK_NAME.\
In the 2nd form, create a link to TARGET in the current directory.\
In the 3rd and 4th forms, create links to each TARGET in DIRECTORY.

ln -s /lxw/maven/apache-maven-3.6.3/bin/mvn /usr/bin/mvn
```

### 安装Jenkins实现自动化布署

``` shell
# 为了能够使用jenkins库，首先需要导入jenkins库的 key 
`To use this repository, run the following command:
 If you've previously imported the key from Jenkins, the "rpm --import" will fail because you already have a key. Please ignore that and move on.
`
sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat/jenkins.repo
sudo rpm --import https://pkg.jenkins.io/redhat/jenkins.io.key
# 安装
yum install jenkins
#删除软件：yum remove jenkins-x.x.x.rpm或者yum erase jenkins-x.x.x.rpm
#升级软件：yum upgrade jenkins或者yum update jenkins
#查询信息：yum info jenkins
#Start/Stop
sudo service jenkins start/stop/restart
sudo chkconfig jenkins on

#登录配置报错，需要安装如下插件
yum install fontconfig
```

#### What does this package do?

- Jenkins will be launched as a daemon on startup. See `/etc/init.d/jenkins` for more details.
- The '`jenkins`' user is created to run this service. If you change this to a different user via the config file, you must change the owner of /var/log/jenkins, /var/lib/jenkins, and /var/cache/jenkins.
- Log file will be placed in `/var/log/jenkins/jenkins.log`. Check this file if you are troubleshooting Jenkins.
- `/etc/sysconfig/jenkins` will capture configuration parameters for the launch.
- By default, Jenkins listen on port 8080. Access this port with your browser to start configuration.  Note that the built-in firewall may have to be opened to access this port from other computers.  (See http://www.cyberciti.biz/faq/disable-linux-firewall-under-centos-rhel-fedora/ for instructions how to disable the firewall permanently)
- A Jenkins RPM repository is added in `/etc/yum.repos.d/jenkins.repo`

#### Configure the firewall

```shell
firewall-cmd --permanent --new-service=jenkins
firewall-cmd --permanent --service=jenkins --set-short="Jenkins Service Ports"
firewall-cmd --permanent --service=jenkins --set-description="Jenkins service firewalld port exceptions"
firewall-cmd --permanent --service=jenkins --add-port=8080/tcp
firewall-cmd --permanent --add-service=jenkins
firewall-cmd --zone=public --add-service=http --permanent
firewall-cmd --reload
firewall-cmd --list-all
```

#### 环境配置

``` shell
`01 登录安装`
http://120.79.28.199:8080
`02 安装依赖后，输入用户名信息`
用户名:jenkins
密码：123456
全名：violetdream
`03 插件管理中，选择Maven Integration插件进行直接安装`

`把jenkins用户加入到dockerroot用户组`
vim /etc/group
#group_name:passwd:GID:user_list
dockerroot:x:666:jenkins
source /etc/group
`在/etc/group 中的每条记录分四个字段：\
第一字段：用户组名称；\
第二字段：用户组密码；\
第三字段：GID\
第四字段：用户列表，每个用户之间用,号分割；本字段可以为空；如果字段为空表示用户组为GID的用户名；

gpasswd -a jenkins dockerroot #将登陆用户加入到docker用户组中
gpasswd -a jenkins root #将登陆用户加入到docker用户组中
newgrp dockerroot #更新用户组

#在脚本中使用sudo命令出现错误时sudo: no tty present and no askpass program specified
vi /etc/sudoers
jenkins ALL=(ALL) NOPASSWD: ALL


```

![image-20200107112415248](C:\Users\刘仙伟\AppData\Roaming\Typora\typora-user-images\image-20200107112415248.png)

### 提交代码-Git版本管理

``` shell
在当前工程目录创建git版本控制，D:\Project_WorkSpace\LXWShopping目录下，跑命令(在liuxianwei_dev分支上进行开发并提交commit，在master分支上进行合并merge，并push到远程github仓库)

git init

git add .

git commit -m "shopping"

git remote add origin [github地址](https://github.com/violetdream/LXWShopping.git)

git push -u origin master

#重点功能 git sparseCheckout 下载github上的子目录
git config core.sparseCheckout true
#加入你要导出的子目录
echo resources/templates/trydone>> .git/info/sparse-checkout
#开始pull下来，与正常使用git一样
git pull origin master
```

### 安装MySQL

``` shell
#拉取境像
docker pull mysql
#官方介绍的yum下载方式
cd /lxw
mkdir mysql
cd /lxw/mysql
wget -i -c http://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm
yum -y install mysql80-community-release-el7-3.noarch.rpm

[root@iZwz99ftqv2b80s2yev48qZ mysql]# yum repolist all | grep mysql
mysql-cluster-7.5-community/x86_64 MySQL Cluster 7.5 Community   disabled
mysql-cluster-7.5-community-source MySQL Cluster 7.5 Community - disabled
mysql-cluster-7.6-community/x86_64 MySQL Cluster 7.6 Community   disabled
mysql-cluster-7.6-community-source MySQL Cluster 7.6 Community - disabled
mysql-cluster-8.0-community/x86_64 MySQL Cluster 8.0 Community   disabled
mysql-cluster-8.0-community-source MySQL Cluster 8.0 Community - disabled
mysql-connectors-community/x86_64  MySQL Connectors Community    enabled:    141
mysql-connectors-community-source  MySQL Connectors Community -  disabled
mysql-tools-community/x86_64       MySQL Tools Community         enabled:    105
mysql-tools-community-source       MySQL Tools Community - Sourc disabled
mysql-tools-preview/x86_64         MySQL Tools Preview           disabled
mysql-tools-preview-source         MySQL Tools Preview - Source  disabled
mysql55-community/x86_64           MySQL 5.5 Community Server    disabled
mysql55-community-source           MySQL 5.5 Community Server -  disabled
mysql56-community/x86_64           MySQL 5.6 Community Server    disabled
mysql56-community-source           MySQL 5.6 Community Server -  disabled
mysql57-community/x86_64           MySQL 5.7 Community Server    disabled
mysql57-community-source           MySQL 5.7 Community Server -  disabled
mysql80-community/x86_64           MySQL 8.0 Community Server    enabled:    161
mysql80-community-source           MySQL 8.0 Community Server -  disabled

yum -y install mysql-community-server

service mysqld start

#查看root用户临时密码
grep 'temporary password' /var/log/mysqld.log
2020-03-24T01:23:10.363630Z 5 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: RGomawzvu6(*
#登录
mysql -uroot -p
#ERROR 1820 (HY000): You must reset your password using ALTER USER statement before executing this statement.
alter user 'root'@'localhost' identified by 'MyNewPass4!';

vi /etc/my.cnf
#创建my.cnf文件置于/etc目录下
[client]
default-character-set=utf8
 
[mysql]
default-character-set=utf8

[mysqld]
init_connect='SET collation_connection = utf8_unicode_ci'
init_connect='SET NAMES utf8'
character-set-server=utf8
collation-server=utf8_unicode_ci
skip-character-set-client-handshake
pid-file        = /var/run/mysqld/mysqld.pid
socket          = /var/run/mysqld/mysqld.sock
datadir         = /var/lib/mysql
secure-file-priv= NULL
# Disabling symbolic-links is recommended to prevent assorted security risks
symbolic-links=0

#登录MySQL
mysql -u root -p
```

``` tiki wiki
Navicat 远程连接docker容器中的mysql 报错1251 - Client does not support authentication protocol 解决办法
mysql8需修改密码策略
set global validate_password.policy=0;
set global validate_password.length=4; 
1、进行授权远程连接(注意mysql 8.0跟之前的授权方式不同),如果限制指定IP能访问，把%替换为IP地址
GRANT ALL ON *.* TO 'root'@'%';
Grant all privileges on root.* to 'root'@'%';
刷新权限
flush privileges;
2、更改加密规则
ALTER USER 'root'@'localhost' IDENTIFIED BY '123456' PASSWORD EXPIRE NEVER;
3、更新root用户密码
ALTER USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY '123456';
##这步很重要，不执行，退出后本地无法登录了
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '123456';
#如应用程序连接报错"Host '' is not allowed to connect to this MySQL server"
mysql>use mysql;
mysql>update user set host= '%' where user = 'root';
4、刷新权限
flush privileges;
```

``` shell
1、将文件shopping_mysql.sql文件上传到宿主机/lxw/mysql目录下
2、创建数据库
CREATE DATABASE shopping_mysql CHARACTER SET utf8 COLLATE utf8_general_ci;
切换数据库use shopping_mysql;
#查看MySQL字符集
show variables like'character%'; 
mysql> show variables like'character%';
+--------------------------+--------------------------------+
| Variable_name            | Value                          |
+--------------------------+--------------------------------+
| character_set_client     | utf8                           |
| character_set_connection | utf8                           |
| character_set_database   | utf8                           |
| character_set_filesystem | binary                         |
| character_set_results    | utf8                           |
| character_set_server     | utf8                           |
| character_set_system     | utf8                           |
| character_sets_dir       | /usr/share/mysql-8.0/charsets/ |
+--------------------------+--------------------------------+
8 rows in set (0.01 sec)
3、执行SQL文件，
方法1: mysql -uroot -p123456 -Dshopping_mysql</data/shopping_mysql.sql;
方法2:连接上数据库内，执行source /lxw/mysql/shopping_mysql.sql;

```

my.cnf配置说明

``` properties
[mysqld]                                        # 服务端基本设置
# 基础设置
server-id = 1                                  # Mysql服务的唯一编号 每个mysql服务Id需唯一
port = 3306                                    # MySQL监听端口
basedir = /opt/app/mysql                      # MySQL安装根目录
datadir = /opt/dataSet/mysqldata/data                     # MySQL数据文件所在位置
tmpdir  = /opt/dataSet/mysqldata/tmp                                  # 临时目录，比如load data infile会用到
socket = /opt/dataSet/mysqldata/tmp/mysql.sock        # 为MySQL客户端程序和服务器之间的本地通讯指定一个套接字文件
pid-file = /opt/dataSet/mysqldata/tmp/mysql.pid      # pid文件所在目录
skip_name_resolve = 1                          # 只能用IP地址检查客户端的登录，不用主机名
character-set-server = utf8mb4                  # 数据库默认字符集,主流字符集支持一些特殊表情符号（特殊表情符占用4个字节）
transaction_isolation = READ-COMMITTED          # 事务隔离级别，默认为可重复读，MySQL默认可重复读级别
collation-server = utf8mb4_general_ci          # 数据库字符集对应一些排序等规则，注意要和character-set-server对应
init_connect='SET NAMES utf8mb4'                # 设置client连接mysql时的字符集,防止乱码
lower_case_table_names = 1                      # 是否对sql语句大小写敏感，1表示不敏感
max_connections = 400                          # 最大连接数
max_connect_errors = 1000                      # 最大错误连接数
explicit_defaults_for_timestamp = true          # TIMESTAMP如果没有显示声明NOT NULL，允许NULL值
max_allowed_packet = 128M                      # SQL数据包发送的大小，如果有BLOB对象建议修改成1G
interactive_timeout = 1800                      # MySQL连接闲置超过一定时间后(单位：秒)将会被强行关闭
wait_timeout = 1800                            # MySQL默认的wait_timeout值为8个小时, interactive_timeout参数需要同时配置才能生效
tmp_table_size = 16M                            # 内部内存临时表的最大值 ，设置成128M；比如大数据量的group by ,order by时可能用到临时表；超过了这个值将写入磁盘，系统IO压力增大
max_heap_table_size = 128M                      # 定义了用户可以创建的内存表(memory table)的大小
query_cache_size = 0                            # 禁用mysql的缓存查询结果集功能；后期根据业务情况测试决定是否开启；大部分情况下关闭下面两项
query_cache_type = 0
default-authentication-plugin  =mysql_native_password #(设置为可远程登录)
 
# 用户进程分配到的内存设置，每个session将会分配参数设置的内存大小
read_buffer_size = 2M                          # MySQL读入缓冲区大小。对表进行顺序扫描的请求将分配一个读入缓冲区，MySQL会为它分配一段内存缓冲区。
read_rnd_buffer_size = 8M                      # MySQL的随机读缓冲区大小
sort_buffer_size = 8M                          # MySQL执行排序使用的缓冲大小
binlog_cache_size = 1M                          # 一个事务，在没有提交的时候，产生的日志，记录到Cache中；等到事务提交需要提交的时候，则把日志持久化到磁盘。默认binlog_cache_size大小32K
 
back_log = 130                                  # 在MySQL暂时停止响应新请求之前的短时间内多少个请求可以被存在堆栈中；官方建议back_log = 50 + (max_connections / 5),封顶数为900
 
# 日志设置
log_error = /opt/dataSet/mysqldata/log/error.log                          # 数据库错误日志文件
slow_query_log = 1                              # 慢查询sql日志设置
long_query_time = 1                            # 慢查询时间；超过1秒则为慢查询
slow_query_log_file = /opt/dataSet/mysqldata/log/slow.log                  # 慢查询日志文件
log_queries_not_using_indexes = 1              # 检查未使用到索引的sql
log_throttle_queries_not_using_indexes = 5      # 用来表示每分钟允许记录到slow log的且未使用索引的SQL语句次数。该值默认为0，表示没有限制
min_examined_row_limit = 100                    # 检索的行数必须达到此值才可被记为慢查询，查询检查返回少于该参数指定行的SQL不被记录到慢查询日志
expire_logs_days = 5                            # MySQL binlog日志文件保存的过期时间，过期后自动删除
 
# 主从复制设置
log-bin = mysql-bin                            # 开启mysql binlog功能
binlog_format = ROW                            # binlog记录内容的方式，记录被操作的每一行
binlog_row_image = minimal                      # 对于binlog_format = ROW模式时，减少记录日志的内容，只记录受影响的列
 
# Innodb设置
innodb_open_files = 500                        # 限制Innodb能打开的表的数据，如果库里的表特别多的情况，请增加这个。这个值默认是300
innodb_buffer_pool_size = 64M                  # InnoDB使用一个缓冲池来保存索引和原始数据，一般设置物理存储的60% ~ 70%；这里你设置越大,你在存取表里面数据时所需要的磁盘I/O越少
innodb_log_buffer_size = 2M                    # 此参数确定写日志文件所用的内存大小，以M为单位。缓冲区更大能提高性能，但意外的故障将会丢失数据。MySQL开发人员建议设置为1－8M之间
innodb_flush_method = O_DIRECT                  # O_DIRECT减少操作系统级别VFS的缓存和Innodb本身的buffer缓存之间的冲突
innodb_write_io_threads = 4                    # CPU多核处理能力设置，根据读，写比例进行调整
innodb_read_io_threads = 4
```



### 安装Nginx

``` shell
cd /lxw/nginx
tar -zxvf nginx-1.17.6.tar.gz
mkdir data
cd nginx-1.17.6
#安装第三方依赖库
yum install pcre-devel
yum install zlib-devel
#安装
./configure --prefix=/lxw/nginx/data
make&&make install
#官方解释
--prefix=path
defines a directory that will keep server files. This same directory will also be used for all relative paths set by configure (except for paths to libraries sources) and in the nginx.conf configuration file. It is set to the /usr/local/nginx directory by default.
#启动和停止
cd ../data
启动  sbin/nginx
停止  ./nginx -s stop
重新加载 ./nginx -s reload
#在/data/conf/nginx.conf上添加 
include /lxw/lxwshopping-front/*.conf;
#添加配置文件/lxw/lxwshopping-front/nginx.conf
server{
	listen 80;
	server_name localhost;
	location / {
		root   /lxw/lxwshopping-front;
		index  index.html index.htm;
	}
	location /user{
		proxy_pass http://172.18.138.75:8081;
	}
	location /shopping{
		proxy_pass http://172.18.138.75:8082;
	}
	location /cashier{
		proxy_pass http://172.18.138.75:8083;
	}
}

```

### 安装RabbitMQ

``` shell
#安装erlang 和 依赖环境
yum install -y erlang
#安装RabbitMQ
yum install rabbitmq-server
#启动RabbitMQ
service rabbitmq-server start
#查看RabbitMQ状态
service rabbitmq-server status
#配置远程访问
vi /etc/rabbitmq/rabbitmq.config 
#保存以下内容，配置允许远程访问的用户，rabbitmq的guest用户默认不允许远程主机访问
[
  {rabbit, [{tcp_listeners, [5672]}, {loopback_users, ["rabbitmq"]}]}
]
#开启web界面管理插件
rabbitmq-plugins enable rabbitmq_management
#重新启动RabbitMQ
service rabbitmq-server restart
#新增一个用户
rabbitmqctl  add_user  rabbitmq  123456
#添加 rabbitmq 用户为administrator角色
rabbitmqctl set_user_tags rabbitmq administrator
#删除一个用记
rabbitmqctl  delete_user  guest
#查看用户列表
rabbitmqctl  list_users

#打开web管理端查看
可以使用浏览器打开web管理端：http://120.79.28.199:15672
guest/guest

#通过命令对rabbitmq进行读写以及管理队列的权限，完成对rabbitmq的授权,然后启动项目就正常了
#设置 rabbitmq 用户的权限，指定允许访问的vhost以及write/read
rabbitmqctl set_permissions -p "/" rabbitmq ".*" ".*" ".*"

#添加queue及Exchange如下图所示
```

``` java
public static final String DELAY_EXCHANGE="delay_exchange";
public static  final String DELAY_QUEUE="delay_queue";
//报错
[ERROR] 2019-12-26 17:14:48,578 --AMQP Connection 120.79.28.199:5672-- [org.springframework.amqp.rabbit.connection.CachingConnectionFactory] Channel shutdown: connection error; protocol method: #method<connection.close>(reply-code=503, reply-text=COMMAND_INVALID - unknown exchange type 'x-delayed-message', class-id=40, method-id=10) 
需要安装rabbitmq_delayed_message_exchange插件
rabbitmq-plugins list
rabbitmq-plugins enable rabbitmq_delayed_message_exchange
```



![image-20191226165049910](C:\Users\刘仙伟\AppData\Roaming\Typora\typora-user-images\image-20191226165049910.png)

![image-20191226165241329](C:\Users\刘仙伟\AppData\Roaming\Typora\typora-user-images\image-20191226165241329.png)

### 安装ZooKeeper

```shell
#下载ZooKeeper,http://zookeeper.apache.org/releases.html 上传至/lxw/zookeeper
cd /lxw/zookeeper
mkdir data
tar -zxvf apache-zookeeper-3.6.0-bin.tar.gz
cd apache-zookeeper-3.6.0-bin/conf
cp zoo_sample.cfg zoo.cfg
vi zoo.cfg
 dataDir=/lxw/zookeeper/data
 admin.serverPort=9999
cd ../bin
#运行zookeeper
sh zkServer.sh start
[root@iZwz99ftqv2b80s2yev48qZ bin]# sh zkServer.sh start
ZooKeeper JMX enabled by default
Using config: /lxw/zookeeper/apache-zookeeper-3.6.0-bin/bin/../conf/zoo.cfg
Starting zookeeper ... STARTED

```

### 安装Redis

``` shell
cd /lxw
mkdir redis
cd redis
#Download, extract and compile Redis with:
$ wget http://download.redis.io/releases/redis-5.0.8.tar.gz
$ tar xzf redis-5.0.8.tar.gz
$ cd redis-5.0.8
$ make
vi redis.conf
修改daemonize 为yes 后台进程
修改bind 172.18.138.75 117.165.42.105 启用protect-mode yes
#The binaries that are now compiled are available in the src directory. Run Redis with:
$ src/redis-server redis.conf
#You can interact with Redis using the built-in client:
$ src/redis-cli
redis> set foo bar
OK
redis> get foo
"bar"
#停止Redis
src/redis-cli -h 172.18.138.75 -p 6379 shutdown
```

## Jenkins运维配置准备

Jenkins上全局基础配置

配置全局工具配置，其中包括`jdk` `Git` `Maven` 

在Jenkins上配置GitHub服务器

![image-20200103154303789](C:\Users\刘仙伟\AppData\Roaming\Typora\typora-user-images\image-20200103154303789.png)

![image-20200108160219734](C:\Users\刘仙伟\AppData\Roaming\Typora\typora-user-images\image-20200108160219734.png)



![image-20200103154041901](C:\Users\刘仙伟\AppData\Roaming\Typora\typora-user-images\image-20200103154041901.png)





## 部署lxwshopping-front

``` shell
#在router/index.js加上
export default new Router({
  base: "/shopping/",//项目名称 访问路由页面都需要加上这个，访问根路径为http://ip:port/shopping/
  mode: "history",//消去#
#在config/index.js中找到build对象修改
assetsPublicPath: '/shopping/',
productionSourceMap: false,
#在lxwshopping-front目录生成安装包
npm run build
#在目录将得到安装包D:\Project_WorkSpace\LXWShopping\lxwshopping-front\dist
#上传Dist目录下的文件到/lxw/lxwshopping-front目录下
http://120.79.28.199/index.html
```

构建Jenkins任务,构建脚本如下所示：

``` shell
#!/bin/sh
cd /var/lib/jenkins/workspace/lxwshopping-front/lxwshopping-front
#注意至少要保证free内存1G可用才能成功，在这里我提前安装好
#sudo npm install
#echo 'lxwshopping-front install OK '
#sudo rm -rf dist
#sudo npm run build
#echo 'lxwshopping-front build OK '
#ls -ltr ./
sudo rm -rf /lxw/lxwshopping-front/static/
sudo cp -rf ./dist/* /lxw/lxwshopping-front/
echo 'copy dist success'
sudo rm -rf dist
```

## 部署User-service

构建Jenkins任务,构建脚本如下所示：

``` shell
#!/bin/sh
cd /var/lib/jenkins/workspace/user-service/lxwshopping-parent
mvn clean
mvn install -Dmaven.test.skip=true
echo 'parent install OK '
cd /var/lib/jenkins/workspace/user-service/lxwshopping-commons
mvn clean
mvn install -Dmaven.test.skip=true
echo 'commons install OK '
cd /var/lib/jenkins/workspace/user-service/user-service
mvn clean
mvn install -Dmaven.test.skip=true
echo 'user services OK '
echo 'ALL INSTALL OK'
if [ ! -d /lxw/user-service/ ]; then
mkdir -p /lxw/user-service/ 
fi
cp -f ./user-provider/target/user-provider-*.jar  /lxw/user-service/
cd /lxw/user-service
#sudo chmod -R 755 /lxw/user-service/
#sudo sh user-service-start.sh test
#echo 'execute user-service-start shell completed!'
```

user-service-start.sh启动user-service的脚本

``` shell
#!/bin/sh

#jarName
projectName=user-service
target=dev
apollo_meta=''
if [ -n "$2" ]; then
    apollo_meta=$2
fi

if [ -n "$1" ]; then
   target=$1
fi
echo "target = "$target

pid=`ps -ef |grep 'java' |grep $projectName |awk '{print $2}'`
if [ -n "$pid" ]; then
    kill -9 $pid
    sleep 3
fi
DATE=`date +%Y-%m-%d`
LogFileName=/lxw/user-service/logs/$projectName-$target

if [ ! -d $LogFileName ]; then
    mkdir -p $LogFileName
fi

case $target in
    local)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS user-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    dev)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS user-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    sit | tag)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS user-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    uat | test)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS user-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    prod)
        JAVA_OPTS="-Xms4096m -Xmx4096m -Xss256k -Xmn256m -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=256m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS user-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    *)
        echo "No this ENV:$target."
        exit 1
    ;;
esac


  echo "Deploy Success"
  #tail -f $LogFileName/start.$DATE.log
  exit 0

EOF
```

user-service-stop.sh停止user-service的脚本

``` shell
#!/bin/sh
#jarName
projectName=user-service
pid=`ps -ef |grep 'java' |grep $projectName |awk '{print $2}'`
if [ -n "$pid" ]; then
    kill -9 $pid
    sleep 3
fi
```



## 部署shopping-service

``` shell
#!/bin/sh
#依赖于user-service项目关系
cd /var/lib/jenkins/workspace/shopping-service/shopping-service
mvn clean
mvn install -Dmaven.test.skip=true
echo 'shopping services OK '
echo 'ALL INSTALL OK'
sudo cp -f ./shopping-provider/target/shopping-provider-*.jar  /lxw/shopping-service/
cd /lxw/shopping-service
sudo chmod -R 755 /lxw/shopping-service/
#sudo sh shopping-service-start.sh test
#echo 'execute shopping-service-start shell completed!'
```

shopping-service-start.sh启动shopping-service的脚本

``` shell
#!/bin/sh
#jarName
projectName=shopping-service
target=dev
apollo_meta=''
if [ -n "$2" ]; then
    apollo_meta=$2
fi

if [ -n "$1" ]; then
   target=$1
fi
echo "target = "$target

pid=`ps -ef |grep 'java' |grep $projectName |awk '{print $2}'`
if [ -n "$pid" ]; then
    kill -9 $pid
    sleep 3
fi
DATE=`date +%Y-%m-%d`
LogFileName=/lxw/$projectName/logs/$projectName-$target

if [ ! -d $LogFileName ]; then
    mkdir -p $LogFileName
fi

case $target in
    local)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS shopping-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    dev)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS shopping-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    sit | tag)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS shopping-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    uat | test)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS shopping-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    prod)
        JAVA_OPTS="-Xms4096m -Xmx4096m -Xss256k -Xmn256m -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=256m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS shopping-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    *)
        echo "No this ENV:$target."
        exit 1
    ;;
esac

  echo "Deploy Success"
  #tail -f $LogFileName/start.$DATE.log
  exit 0

EOF
```

shopping-service-stop.sh停止shopping-service的脚本

``` shell
#!/bin/sh
#jarName
projectName=shopping-service
pid=`ps -ef |grep 'java' |grep $projectName |awk '{print $2}'`
if [ -n "$pid" ]; then
    kill -9 $pid
    sleep 3
fi
```



##  部署order-service

``` shell
#!/bin/sh
#依赖于user-service项目关系
cd /var/lib/jenkins/workspace/order-service/order-service
mvn clean
mvn install -Dmaven.test.skip=true
echo 'order services OK '
echo 'ALL INSTALL OK'
sudo cp -f ./order-provider/target/order-provider-*.jar  /lxw/order-service/
cd /lxw/order-service
sudo chmod -R 755 /lxw/order-service/
#sudo sh order-service-start.sh test
#echo 'execute order-service-start shell completed!'
```

order-service-start.sh启动order-service的脚本

``` shell
#!/bin/sh
#jarName
projectName=order-service
target=dev
apollo_meta=''
if [ -n "$2" ]; then
    apollo_meta=$2
fi

if [ -n "$1" ]; then
   target=$1
fi
echo "target = "$target

pid=`ps -ef |grep 'java' |grep $projectName |awk '{print $2}'`
if [ -n "$pid" ]; then
    kill -9 $pid
    sleep 3
fi
DATE=`date +%Y-%m-%d`
LogFileName=/lxw/$projectName/logs/$projectName-$target

if [ ! -d $LogFileName ]; then
    mkdir -p $LogFileName
fi

case $target in
    local)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS order-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    dev)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS order-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    sit | tag)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS order-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    uat | test)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS order-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    prod)
        JAVA_OPTS="-Xms4096m -Xmx4096m -Xss256k -Xmn256m -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=256m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS order-provider*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    *)
        echo "No this ENV:$target."
        exit 1
    ;;
esac

  echo "Deploy Success"
  #tail -f $LogFileName/start.$DATE.log
  exit 0

EOF
```

order-service-stop.sh停止order-service的脚本

``` shell
#!/bin/sh
#jarName
projectName=order-service
pid=`ps -ef |grep 'java' |grep $projectName |awk '{print $2}'`
if [ -n "$pid" ]; then
    kill -9 $pid
    sleep 3
fi
```



## 部署lxwshopping-user

``` shell
#!/bin/sh
#依赖于user-service项目关系
cd /var/lib/jenkins/workspace/lxwshopping-user/lxwshopping-user
mvn clean
mvn install -Dmaven.test.skip=true
echo 'lxwshopping-user OK '
echo 'ALL INSTALL OK'
sudo cp -f ./target/lxwshopping-user-*.jar  /lxw/lxwshopping-user/
cd /lxw/lxwshopping-user
sudo chmod -R 755 /lxw/lxwshopping-user/
#sudo sh lxwshopping-user-start.sh test
#echo 'execute lxwshopping-user-start shell completed!'
```

lxwshopping-user-start.sh启动lxwshopping-user的脚本

``` shell
#!/bin/sh
#jarName
projectName=lxwshopping-user
target=dev
apollo_meta=''
if [ -n "$2" ]; then
    apollo_meta=$2
fi

if [ -n "$1" ]; then
   target=$1
fi
echo "target = "$target

pid=`ps -ef |grep 'java' |grep $projectName |awk '{print $2}'`
if [ -n "$pid" ]; then
    kill -9 $pid
    sleep 3
fi
DATE=`date +%Y-%m-%d`
LogFileName=/lxw/$projectName/logs/$projectName-$target

if [ ! -d $LogFileName ]; then
    mkdir -p $LogFileName
fi

case $target in
    local)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS lxwshopping-user*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    dev)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS lxwshopping-user*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    sit | tag)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS lxwshopping-user*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    uat | test)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS lxwshopping-user*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    prod)
        JAVA_OPTS="-Xms4096m -Xmx4096m -Xss256k -Xmn256m -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=256m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS lxwshopping-user*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    *)
        echo "No this ENV:$target."
        exit 1
    ;;
esac
  echo "Deploy Success"
  #tail -f $LogFileName/start.$DATE.log
  exit 0
EOF
```

lxwshopping-user-stop.sh停止lxwshopping-user的脚本

``` shell
#!/bin/sh
#jarName
projectName=lxwshopping-user
pid=`ps -ef |grep 'java' |grep $projectName |awk '{print $2}'`
if [ -n "$pid" ]; then
    kill -9 $pid
    sleep 3
fi
```



## 部署lxwshopping-shopping

``` shell
#!/bin/sh
#依赖于user-service项目关系
cd /var/lib/jenkins/workspace/lxwshopping-shopping/lxwshopping-shopping
mvn clean
mvn install -Dmaven.test.skip=true
echo 'lxwshopping-shopping OK '
echo 'ALL INSTALL OK'
sudo cp -f ./target/lxwshopping-shopping-*.jar  /lxw/lxwshopping-shopping/
cd /lxw/lxwshopping-shopping
sudo chmod -R 755 /lxw/lxwshopping-shopping/
#sudo sh lxwshopping-shopping-start.sh test
#echo 'execute lxwshopping-shopping-start shell completed!'
```

lxwshopping-shopping-start.sh启动lxwshopping-shopping的脚本

``` shell
#!/bin/sh
#jarName
projectName=lxwshopping-shopping
target=dev
apollo_meta=''
if [ -n "$2" ]; then
    apollo_meta=$2
fi

if [ -n "$1" ]; then
   target=$1
fi
echo "target = "$target

pid=`ps -ef |grep 'java' |grep $projectName |awk '{print $2}'`
if [ -n "$pid" ]; then
    kill -9 $pid
    sleep 3
fi
DATE=`date +%Y-%m-%d`
LogFileName=/lxw/$projectName/logs/$projectName-$target

if [ ! -d $LogFileName ]; then
    mkdir -p $LogFileName
fi

case $target in
    local)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS lxwshopping-shopping*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    dev)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS lxwshopping-shopping*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    sit | tag)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS lxwshopping-shopping*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    uat | test)
        JAVA_OPTS="-Xms50m -Xmx50m -Xss256k -Xmn50m -XX:MetaspaceSize=50m -XX:MaxMetaspaceSize=50m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS lxwshopping-shopping*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    prod)
        JAVA_OPTS="-Xms4096m -Xmx4096m -Xss256k -Xmn256m -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=256m -XX:SurvivorRatio=8"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParallelGC -XX:+PrintGCDetails  -Xloggc:$LogFileName/gc.log"
        JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LogFileName/dump"
        JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=$target  -Dapollo_meta=$apollo_meta"
        nohup java -jar $JAVA_OPTS lxwshopping-shopping*.jar >> $LogFileName/start.$DATE.log 2>&1 &
    ;;
    *)
        echo "No this ENV:$target."
        exit 1
    ;;
esac
  echo "Deploy Success"
  #tail -f $LogFileName/start.$DATE.log
  exit 0
EOF
```

lxwshopping-shopping-stop.sh停止lxwshopping-shopping的脚本

``` shell
#!/bin/sh
#jarName
projectName=lxwshopping-shopping
pid=`ps -ef |grep 'java' |grep $projectName |awk '{print $2}'`
if [ -n "$pid" ]; then
    kill -9 $pid
    sleep 3
fi
```



## 小技巧

查看CentOS系统中占用内存量前十的应用程序情况

``` shell
ps aux | head -1; ps aux | sort -k4nr | head -10
```



